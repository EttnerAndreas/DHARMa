x = structure(list(ID = structure(c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
                                1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
                                2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
                                3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L), .Label = c("1", "2", "4", "6", 
                                                                            "7", "8", "9", "10", "11", "13", "15", "16", "17", "18", "20", 
                                                                            "22", "24", "26", "28", "29", "32", "34", "35", "36", "37", "39", 
                                                                            "41", "42", "44", "47"), class = "factor"), Year = structure(c(1L, 
                                                                                                                                           2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L, 11L, 12L, 13L, 14L, 15L, 
                                                                                                                                           16L, 1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L, 11L, 12L, 13L, 
                                                                                                                                           14L, 15L, 16L, 1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L, 11L, 
                                                                                                                                           12L, 13L, 14L, 15L, 16L), .Label = c("1991", "1992", "1993", 
                                                                                                                                                                                "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", 
                                                                                                                                                                                "2002", "2003", "2004", "2005", "2006"), class = "factor"), y = c(5, 
                                                                                                                                                                                                                                                  10, 6, 9, 9, 4, 7, 3, 4, 3, 6, 0, 3, 1, 0, 1, 2, 2, 3, 7, 12, 
                                                                                                                                                                                                                                                  13, 9, 4, 9, 5, 7, 4, 1, 0, 0, 1, 0, 5, 5, 1, 1, 3, 3, 5, 1, 
                                                                                                                                                                                                                                                  1, 0, 0, 0, 0, 0, 0), x1 = c(0L, 0L, 3L, 3L, 3L, 5L, 3L, 3L, 
                                                                                                                                                                                                                                                                               7L, 6L, 3L, 4L, 4L, 8L, 1L, 8L, 0L, 0L, 0L, 0L, 0L, 3L, 2L, 1L, 
                                                                                                                                                                                                                                                                               1L, 4L, 2L, 1L, 1L, 2L, 3L, 3L, 0L, 2L, 1L, 0L, 0L, 0L, 0L, 0L, 
                                                                                                                                                                                                                                                                               4L, 0L, 4L, 2L, 3L, 0L, 1L, 1L), x2 = structure(c(17.8639165094919, 
                                                                                                                                                                                                                                                                                                                                 50.1020935887824, 31.1538050589932, 37.2033807072519, 24.8991492903416, 
                                                                                                                                                                                                                                                                                                                                 174.175350109063, 31.4251082710696, 41.1084018081777, 10.1998547908863, 
                                                                                                                                                                                                                                                                                                                                 12.067302257998, 17.0903625146349, 8.85325909190098, 6.47558100093125, 
                                                                                                                                                                                                                                                                                                                                 7.01269692974855, 1.65337279464797, 0.191518074572238, 0.018595041322314, 
                                                                                                                                                                                                                                                                                                                                 0.0271994246139054, 0.96361787450096, 2.5959514058137, 18.3142899841373, 
                                                                                                                                                                                                                                                                                                                                 20.4702770445124, 5.42130949779285, 38.2154457985312, 16.0989967955186, 
                                                                                                                                                                                                                                                                                                                                 17.8598514126896, 15.665921501896, 21.340517631197, 14.2341841365699, 
                                                                                                                                                                                                                                                                                                                                 2.78195283698102, 0.298904312089158, 0.0705563395778743, 5.8217279902149, 
                                                                                                                                                                                                                                                                                                                                 7.71441353992869, 49.03135409192, 12.6620210527394, 28.2588539794557, 
                                                                                                                                                                                                                                                                                                                                 6.86073281363667, 5.33888953019871, 6.6234384209806, 3.40017246160656, 
                                                                                                                                                                                                                                                                                                                                 8.56303764026254, 13.06239723398, 3.24123669578228, 2.2556228963796, 
                                                                                                                                                                                                                                                                                                                                 1.23481355658365, 0.995714220297008, 0.149001034360244), .Dim = 48L, .Dimnames = list(
                                                                                                                                                                                                                                                                                                                                   c("1990_A", "1991_A", "1992_A", "1993_A", "1994_A", "1995_A", 
                                                                                                                                                                                                                                                                                                                                     "1996_A", "1997_A", "1998_A", "1999_A", "2000_A", "2001_A", 
                                                                                                                                                                                                                                                                                                                                     "2002_A", "2003_A", "2004_A", "2005_A", "1990_B", "1991_B", 
                                                                                                                                                                                                                                                                                                                                     "1992_B", "1993_B", "1994_B", "1995_B", "1996_B", "1997_B", 
                                                                                                                                                                                                                                                                                                                                     "1998_B", "1999_B", "2000_B", "2001_B", "2002_B", "2003_B", 
                                                                                                                                                                                                                                                                                                                                     "2004_B", "2005_B", "1990_C", "1991_C", "1992_C", "1993_C", 
                                                                                                                                                                                                                                                                                                                                     "1994_C", "1995_C", "1996_C", "1997_C", "1998_C", "1999_C", 
                                                                                                                                                                                                                                                                                                                                     "2000_C", "2001_C", "2002_C", "2003_C", "2004_C", "2005_C"
                                                                                                                                                                                                                                                                                                                                   )))), .Names = c("ID", "Year", "y", "x1", "x2"), row.names = c(1L, 
                                                                                                                                                                                                                                                                                                                                                                                                  2L, 3L, 4L, 160L, 5L, 162L, 163L, 164L, 6L, 166L, 7L, 8L, 9L, 
                                                                                                                                                                                                                                                                                                                                                                                                  170L, 171L, 172L, 173L, 174L, 175L, 176L, 177L, 178L, 179L, 180L, 
                                                                                                                                                                                                                                                                                                                                                                                                  181L, 182L, 183L, 184L, 10L, 186L, 11L, 188L, 12L, 190L, 191L, 
                                                                                                                                                                                                                                                                                                                                                                                                  192L, 13L, 194L, 14L, 196L, 197L, 15L, 199L, 200L, 16L, 202L, 
                                                                                                                                                                                                                                                                                                                                                                                                  17L), class = c("plm.dim", "data.frame"))


library(lme4)

g.test<-glmer.nb(y ~ x1 + x2 + x1:x2 + (1|Year), data=x, nAGQ = 1L, start = 0.21, control=glmerControl(optimizer="bobyqa", boundary.tol=1e-2 ,check.conv.singular =.makeCC(action ="ignore",tol=1e-2),tolPwrss=1e-2))

library(DHARMa)

res = simulateResiduals(g.test)
plot(res)

res = simulateResiduals(g.test, refit = T)
plot(res)



###### Tweedie ######

# 265

library(lme4)
library(statmod)

#create toy dataset
df1 <- data.frame(production=c(15,12,10,9,6,8,9,5,3,3,2,1,0,0,0,0), Treatment_Num=c(1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4), Genotype=c(1,1,2,2,1,1,2,2,1,1,2,2,1,1,2,2))

#run tweedie model
df1_tweedie <- glmer(production ~ Treatment_Num +(1|Genotype),
                     data = df1, family=tweedie(var.power=1.9,link.power=0))

#load DHARMa
require(DHARMa)
#I get an error when I try running this line:
df1_tweedie_res <- simulateResiduals(df1_tweedie)



tweedie <- function (var.power = 0, link.power = 1 - var.power) {
  out = statmod::tweedie(var.power = var.power, link.power = link.power)
  
  simfun <- function(object, nsim) {
    # my implementation
  }
  
  out$simulate = simfun
  return(out)
}






