---
title: "GAM problems"
author: "Florian Hartig"
date: "10 Dec 2016"
output: 
  html_document: 
    keep_md: yes
---

This file demonstrates some problems with n/k binomials and gam from mgcv that were fixed by a hack for DHARMa > 0.1.3 

You must not have DHARMa loaded to see this problem

```{r}
library(mgcv)
```

Test data is loaded here (hidden)

```{r, echo = F}
testData = structure(list(ID = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 
13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 
29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 
45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 
61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 
77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 
93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 
107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 
120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 
133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 
146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 
159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 
172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 
185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 
198, 199, 200), observedResponse1 = c(14, 17, 16, 13, 9, 7, 11, 
10, 13, 11, 12, 11, 10, 14, 8, 11, 4, 8, 16, 7, 5, 3, 9, 11, 
11, 10, 7, 15, 12, 4, 7, 13, 13, 5, 17, 12, 6, 11, 11, 3, 7, 
11, 7, 10, 10, 2, 5, 13, 11, 8, 6, 9, 10, 11, 5, 10, 9, 12, 10, 
10, 10, 11, 8, 15, 7, 14, 14, 14, 11, 7, 9, 10, 14, 16, 13, 7, 
13, 12, 9, 17, 9, 14, 16, 11, 11, 6, 13, 10, 9, 17, 12, 6, 6, 
11, 10, 9, 14, 6, 8, 9, 10, 8, 7, 14, 5, 2, 16, 10, 10, 7, 16, 
16, 6, 10, 8, 5, 13, 11, 10, 12, 7, 9, 12, 15, 10, 9, 8, 10, 
10, 12, 10, 6, 11, 8, 6, 10, 12, 14, 12, 14, 9, 8, 17, 5, 4, 
5, 10, 10, 13, 12, 12, 10, 10, 7, 10, 14, 9, 9, 5, 8, 14, 9, 
12, 6, 5, 11, 9, 9, 8, 13, 9, 16, 8, 12, 9, 9, 13, 12, 9, 4, 
15, 11, 13, 11, 14, 4, 7, 8, 7, 15, 10, 4, 17, 9, 10, 6, 17, 
11, 12, 13), observedResponse0 = c(6, 3, 4, 7, 11, 13, 9, 10, 
7, 9, 8, 9, 10, 6, 12, 9, 16, 12, 4, 13, 15, 17, 11, 9, 9, 10, 
13, 5, 8, 16, 13, 7, 7, 15, 3, 8, 14, 9, 9, 17, 13, 9, 13, 10, 
10, 18, 15, 7, 9, 12, 14, 11, 10, 9, 15, 10, 11, 8, 10, 10, 10, 
9, 12, 5, 13, 6, 6, 6, 9, 13, 11, 10, 6, 4, 7, 13, 7, 8, 11, 
3, 11, 6, 4, 9, 9, 14, 7, 10, 11, 3, 8, 14, 14, 9, 10, 11, 6, 
14, 12, 11, 10, 12, 13, 6, 15, 18, 4, 10, 10, 13, 4, 4, 14, 10, 
12, 15, 7, 9, 10, 8, 13, 11, 8, 5, 10, 11, 12, 10, 10, 8, 10, 
14, 9, 12, 14, 10, 8, 6, 8, 6, 11, 12, 3, 15, 16, 15, 10, 10, 
7, 8, 8, 10, 10, 13, 10, 6, 11, 11, 15, 12, 6, 11, 8, 14, 15, 
9, 11, 11, 12, 7, 11, 4, 12, 8, 11, 11, 7, 8, 11, 16, 5, 9, 7, 
9, 6, 16, 13, 12, 13, 5, 10, 16, 3, 11, 10, 14, 3, 9, 8, 7), 
    Environment1 = c(0.84275038773194, 0.894643702078611, 0.814242111053318, 
    0.720167240593582, -0.0881688478402793, -0.240512737538666, 
    -0.153913689311594, 0.249218858312815, -0.0589379440061748, 
    0.52926608780399, 0.32724301982671, 0.40246723452583, 0.189404924865812, 
    0.625767050776631, -0.691932210233063, 0.835556307807565, 
    -0.738246734719723, -0.913530204445124, 0.482638261280954, 
    -0.0496143554337323, -0.97867476567626, -0.744773576036096, 
    0.201346952002496, 0.140314694028348, 0.0344433756545186, 
    0.0477328654378653, -0.720298136118799, 0.638825942296535, 
    0.612875508610159, -0.962177155073732, -0.947459571063519, 
    -0.0156180756166577, 0.170722698792815, -0.651818120852113, 
    0.710389374755323, 0.0934429271146655, -0.942213280592114, 
    0.100047749467194, -0.512355967890471, -0.917692658025771, 
    -0.657653139904141, 0.468228423967957, -0.217716581188142, 
    0.575980340596288, -0.60485466523096, -0.821339184418321, 
    -0.535145371686667, 0.675085885915905, -0.678987908177078, 
    -0.418188820593059, -0.149709271267056, -0.404090052004904, 
    0.179579389747232, 0.674731745850295, -0.911716095171869, 
    0.772485735826194, -0.479052720591426, 0.612310769036412, 
    0.594854080118239, -0.461513478774577, -0.576934427022934, 
    0.996840700041503, -0.218306941911578, 0.668427385389805, 
    -0.555180166848004, 0.743630835320801, 0.494167417287827, 
    0.679248961154372, 0.483187403529882, -0.176241714973003, 
    -0.170010678935796, 0.309774799272418, 0.207059155683964, 
    0.46566721284762, 0.499974749982357, -0.92250564461574, 0.424900386016816, 
    0.976730686146766, -0.658157501835376, 0.910314651671797, 
    0.932390126865357, 0.466984312981367, 0.814204275608063, 
    -0.246691617183387, 0.567471037153155, -0.474105753470212, 
    0.652476490009576, -0.00207722187042236, -0.37673657014966, 
    0.630041751079261, 0.0513511877506971, -0.657908633351326, 
    -0.346139824949205, -0.312686496414244, 0.861054915003479, 
    -0.468579221982509, 0.627113756258041, 0.0371443806216121, 
    -0.638132052030414, 0.495896039996296, -0.0968393860384822, 
    -0.931229610461742, -0.616742725949734, 0.423009661026299, 
    -0.859876318834722, -0.916360204108059, 0.797533807344735, 
    0.813013246282935, 0.383557881694287, -0.688900043722242, 
    0.526833961717784, 0.970896533224732, 0.591831288300455, 
    -0.0980190197005868, -0.36274934373796, -0.892611321527511, 
    0.454232465941459, 0.557409660425037, 0.127384250517935, 
    0.336443016305566, -0.81390337459743, 0.0336917596869171, 
    0.476835155393928, -0.0160761242732406, 0.794870753306895, 
    -0.0791422910988331, 0.858363377861679, 0.185261539649218, 
    0.574267584364861, 0.458707110956311, -0.661005723290145, 
    -0.699046190362424, 0.689415298867971, -0.649786109104753, 
    -0.967244199942797, 0.151175124570727, 0.481881236191839, 
    0.750790119171143, 0.473035084549338, 0.528570037800819, 
    -0.570637032855302, 0.300257165450603, 0.732214461546391, 
    -0.880699795670807, -0.533363244030625, -0.392535624559969, 
    0.791597548872232, 0.120633412152529, 0.329757153522223, 
    -0.231224661227316, -0.102278264705092, 0.311260723508894, 
    0.587607473600656, -0.770969230215997, -0.814486585091799, 
    0.647078250069171, -0.135865150485188, -0.301199438516051, 
    -0.445772760547698, 0.135735285002738, 0.893902619369328, 
    -0.776044204831123, -0.129790350329131, -0.0720758261159062, 
    -0.53373648179695, 0.848410033155233, -0.0109235695563257, 
    -0.677323466166854, -0.414717660751194, 0.819121598266065, 
    -0.98129289643839, 0.583249974995852, 0.201916363555938, 
    0.46264165174216, -0.538254741113633, -0.069407356902957, 
    0.277384946588427, 0.463064017239958, 0.00305226072669029, 
    -0.805041078943759, 0.942866280209273, 0.457030534278601, 
    0.362252715509385, 0.437118357047439, 0.907289884053171, 
    -0.887762977275997, -0.340546264778823, -0.500024750363082, 
    -0.882962550036609, 0.610430797096342, -0.392749826889485, 
    -0.824411427136511, 0.77105914382264, -0.0298608732409775, 
    -0.250120142009109, -0.658081234898418, 0.735470834188163, 
    -0.325480737257749, 0.349280850961804, 0.478399963583797), 
    group = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
    1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
    2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 
    3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 
    4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 
    5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 
    6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 
    7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 
    8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 9, 9, 9, 
    9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 
    10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10), 
    time = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 
    16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 
    31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 
    46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 
    61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 
    76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 
    91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 
    105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 
    117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 
    129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 
    141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 
    153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 
    165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 
    177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 
    189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200
    ), x = c(0.056963826995343, 0.420352014480159, 0.611447275150567, 
    0.321510264184326, 0.623425185680389, 0.162620410788804, 
    0.588222268968821, 0.746578916441649, 0.2208997446578, 0.0149870852474123, 
    0.0522522765677422, 0.834521086886525, 0.574185050791129, 
    0.269040453014895, 0.288314623292536, 0.608400762779638, 
    0.930074147414416, 0.955621963134035, 0.118768376298249, 
    0.399052759632468, 0.026343775447458, 0.761066952487454, 
    0.607212134636939, 0.55520284245722, 0.515064663020894, 0.793018185067922, 
    0.224006957141683, 0.118194326292723, 0.374836497474462, 
    0.659676845418289, 0.383652175310999, 0.304607545025647, 
    0.113228330621496, 0.618119333172217, 0.869869528803974, 
    0.242137769469991, 0.626258642878383, 0.521808452438563, 
    0.633636650396511, 0.122240748489276, 0.362026549875736, 
    0.606272851349786, 0.697690307861194, 0.843844367424026, 
    0.283497460884973, 0.362641870975494, 0.43612983613275, 0.191674745175987, 
    0.569359353045002, 0.481153157772496, 0.867824820801616, 
    0.786377071635798, 0.87130105914548, 0.273762228665873, 0.967507622903213, 
    0.540348433190957, 0.135556033113971, 0.0654059648513794, 
    0.270813395036384, 0.0663834270089865, 0.899220097111538, 
    0.151784247485921, 0.872055657673627, 0.147909889230505, 
    0.688177719479427, 0.596487667877227, 0.310648921644315, 
    0.173504674108699, 0.455190489068627, 0.683509287191555, 
    0.533685134956613, 0.256381168495864, 0.806942553957924, 
    0.439088949467987, 0.865060943178833, 0.508082465734333, 
    0.68947671703063, 0.439634643960744, 0.711408318253234, 0.576114124152809, 
    0.633676412282512, 0.0205100304447114, 0.924809549702331, 
    0.959286495344713, 0.716428323416039, 0.905190724181011, 
    0.0557937936391681, 0.121914885006845, 0.432471932610497, 
    0.0744953665416688, 0.843911451520398, 0.792778787901625, 
    0.118022496346384, 0.706682628951967, 0.606130992993712, 
    0.829013582319021, 0.593125897692516, 0.891077501466498, 
    0.0189867885783315, 0.972272192826495, 0.0494604867417365, 
    0.816945053869858, 0.341251117410138, 0.807836360065266, 
    0.865597264142707, 0.0949623892083764, 0.526435262989253, 
    0.472902649082243, 0.45782269211486, 0.206147427670658, 0.90172014804557, 
    0.732261698460206, 0.82226689090021, 0.606045132270083, 0.732562967576087, 
    0.530492489458993, 0.220807773061097, 0.696489747148007, 
    0.193899414502084, 0.528571599395946, 0.198487965390086, 
    0.632213342702016, 0.257544888881966, 0.612733901012689, 
    0.0449205120094121, 0.0825797326397151, 0.600991333369166, 
    0.608334740391001, 0.22636185050942, 0.994985323864967, 0.430481264833361, 
    0.350035953102633, 0.844720542430878, 0.560224897228181, 
    0.499125065980479, 0.746593703981489, 0.556802853709087, 
    0.61965083447285, 0.838475894881412, 0.856166122015566, 0.908736021490768, 
    0.315922553185374, 0.654819657560438, 0.241680575534701, 
    0.600791274104267, 0.715047441190109, 0.611866968218237, 
    0.961098700528964, 0.00541920051909983, 0.369905554922298, 
    0.666649654507637, 0.441872814437374, 0.967937435023487, 
    0.990038964897394, 0.918540743645281, 0.33940795599483, 0.464131497777998, 
    0.562953792046756, 0.205968142021447, 0.859371000435203, 
    0.263886179775, 0.857635922497138, 0.953062589280307, 0.866977419471368, 
    0.175577307585627, 0.0594896331895143, 0.768283826299012, 
    0.0973185512702912, 0.73400248773396, 0.509112302213907, 
    0.0485026286914945, 0.782269428484142, 0.654606780270115, 
    0.235800656257197, 0.120149279944599, 0.93112236331217, 0.0930565213784575, 
    0.887098263017833, 0.0153793594799936, 0.711646665586159, 
    0.610922347055748, 0.232657049782574, 0.394560462562367, 
    0.138397761853412, 0.81252590357326, 0.37553349416703, 0.148093230091035, 
    0.592335829511285, 0.37577120331116, 0.883549368241802, 0.603248733561486, 
    0.808157552732155, 0.173703136853874, 0.738009850960225, 
    0.827066138386726, 0.90958820306696, 0.692819305229932, 0.719714866019785, 
    0.166626672493294, 0.593017473816872), y = c(0.707060107029974, 
    0.800504142418504, 0.535860521253198, 0.654084162786603, 
    0.770191811025143, 0.849220990668982, 0.583459923276678, 
    0.629873427329585, 0.0134597758296877, 0.577608137158677, 
    0.759105236269534, 0.231766312150285, 0.171694249147549, 
    0.440985304536298, 0.380201379302889, 0.406849884195253, 
    0.65805363887921, 0.74026212352328, 0.624509379267693, 0.808824599487707, 
    0.854238674044609, 0.187626167898998, 0.0870168309193105, 
    0.213286711135879, 0.183632408967242, 0.366337694693357, 
    0.298746033105999, 0.906518295174465, 0.551753541454673, 
    0.810199110070243, 0.963477184064686, 0.544133139541373, 
    0.162501900224015, 0.98538483469747, 0.275738147553056, 0.135365043068305, 
    0.694111103890464, 0.505464718909934, 0.39807385019958, 0.54283823701553, 
    0.404357157414779, 0.929279489442706, 0.880316287279129, 
    0.634045639773831, 0.981159088434651, 0.152753164293244, 
    0.982858646893874, 0.000555680831894279, 0.675172758055851, 
    0.0259012803435326, 0.622842993121594, 0.761314882198349, 
    0.346190262353048, 0.934127578511834, 0.639140570070595, 
    0.844710582401603, 0.844910103129223, 0.576771807158366, 
    0.73167961020954, 0.813752218848094, 0.167477876413614, 0.684868768788874, 
    0.25927993026562, 0.0394648164510727, 0.380472286604345, 
    0.34685058100149, 0.989999762736261, 0.239432680886239, 0.0837195473723114, 
    0.286186994751915, 0.494301700731739, 0.0636608072090894, 
    0.480960983084515, 0.957815096480772, 0.646134072449058, 
    0.616619852138683, 0.479640880599618, 0.728721715742722, 
    0.979987964965403, 0.554376311134547, 0.945964889135212, 
    0.118630717741325, 0.381477485410869, 0.493195719318464, 
    0.793251553783193, 0.61178318457678, 0.302612082101405, 0.313084991648793, 
    0.646613019751385, 0.222015533596277, 0.182131783338264, 
    0.54039375577122, 0.395240117795765, 0.46422465168871, 0.890248335432261, 
    0.777163601713255, 0.169775372138247, 0.872064791619778, 
    0.892275263555348, 0.910263977944851, 0.894157679751515, 
    0.82951639033854, 0.20950414869003, 0.476730053080246, 0.889111395692453, 
    0.832112991949543, 0.679197634104639, 0.251418296247721, 
    0.221179241780192, 0.367934506619349, 0.908271524589509, 
    0.26768787112087, 0.94836028222926, 0.396258587483317, 0.286284428322688, 
    0.635230813641101, 0.741831953637302, 0.805644202278927, 
    0.114533987594768, 0.228024481562898, 0.965459864586592, 
    0.577605538070202, 0.268048875266686, 0.190439325291663, 
    0.448313096538186, 0.254016889957711, 0.438767984975129, 
    0.422166171483696, 0.0186596401035786, 0.685213465010747, 
    0.468848932534456, 0.471803956897929, 0.676756402477622, 
    0.409969166386873, 0.722603961825371, 0.777800178155303, 
    0.0763077617157251, 0.137941112741828, 0.927268950268626, 
    0.30893513513729, 0.721342002041638, 0.655237004859373, 0.844601600663736, 
    0.25207655900158, 0.456518640741706, 0.421153033617884, 0.558721435489133, 
    0.194175035459921, 0.868502069730312, 0.0973376869224012, 
    0.642269629985094, 0.265687986975536, 0.254870174918324, 
    0.652499389369041, 0.0282519308384508, 0.74771766923368, 
    0.857246643397957, 0.542560660513118, 0.13535345136188, 0.814580022357404, 
    0.218811248196289, 0.303904952481389, 0.498526614392176, 
    0.558149159653112, 0.689622355159372, 0.181704802671447, 
    0.167078012600541, 0.346161904511973, 0.133824039483443, 
    0.595633260440081, 0.97218643175438, 0.496479318477213, 0.767273387406021, 
    0.906797721749172, 0.226094131125137, 0.415499585215002, 
    0.128402237780392, 0.39083593362011, 0.118074978003278, 0.727407150669023, 
    0.807063658488914, 0.376123589230701, 0.437249345937744, 
    0.390101130586118, 0.12818716512993, 0.238780546933413, 0.269683307036757, 
    0.645391919650137, 0.609382961411029, 0.879617882426828, 
    0.878722870722413, 0.52279019379057, 0.884675212437287, 0.205795926740393, 
    0.167668695095927, 0.468031344236806, 0.677752958843485, 
    0.901976933702826, 0.907521366141737, 0.35032030264847)), .Names = c("ID", 
"observedResponse1", "observedResponse0", "Environment1", "group", 
"time", "x", "y"), row.names = c(NA, -200L), class = "data.frame")
```


```{r}
# Fitting a glm and a gam

fittedModelGLM <- glm(cbind(observedResponse1,observedResponse0)  ~ Environment1 , family = "binomial", data = testData)

fittedModelGAM <- gam(cbind(observedResponse1,observedResponse0) ~ s(Environment1) ,family = "binomial", data = testData)
```

We can simulate from both models 

```{r}
out = simulate(fittedModelGLM, nsim = 10)
out2 = simulate(fittedModelGAM, nsim = 10)
```

however, although the class of both objects is df, they have different dimensions

```{r}
dim(out)
dim(out2)
```

(seemingly), because the internal data is identical. 

I was tracking the problem back through the simulate function to the family function to the fitted function - the issue is that the fitted function for gam provides a unnamed vector

```{r}
fitted(fittedModelGLM)
fitted(fittedModelGAM)
```

Small difference, but that confuses the family$family$simulate() function, and that in turn provides the wrong data format for the simulate function 


