---
title: "Deviance residuals"
author: "Florian Hartig"
date: "25 Nov 2016"
output: 
  html_document: 
    keep_md: yes
    toc: true

---

**Summary:** This document demonstrates that deviance residuals for GLMs are not normal, unless the distribution (in this case Poisson) is itself in a range that is approximately normal.

Creating data for Poisson with large intercept (data1, i.e. nearly normal distribution), and Poisson with small intercept (data 2, strongly skewed)


```{r}
set.seed(123)
library(DHARMa)

testData = createData(sampleSize = 500, intercept = 5, overdispersion = 0, family = poisson(), randomEffectVariance = 0)
fittedModel <- glm(observedResponse ~ Environment1 , family = "poisson", data = testData)
res = residuals(fittedModel, type = "deviance")

testData2 = createData(sampleSize = 500, intercept = -2, overdispersion = 0, family = poisson(), randomEffectVariance = 0)
fittedModel2 <- glm(observedResponse ~ Environment1 , family = "poisson", data = testData2)
res2 = residuals(fittedModel2, type = "deviance")

```

Test for normality

```{r}
shapiro.test(res)
shapiro.test(res2)
```


Visual comparison via Normal qq Plots

```{r}
par(mfrow = c(1,2))
qqnorm(res, main = "QQnorm Data1")
qqnorm(res2, main = "QQnorm  Data2")
```

DHARMa corrects this problem (showing here only model 2 because 1 is no problem anyway)


```{r}
resDHARMa = simulateResiduals(fittedModel2)
plot(resDHARMa)
```

